{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Canonical E-commerce Metrics Schema",
  "description": "Unified schema for sales and ads metrics across Amazon SP-API, Amazon Ads API, and Walmart APIs",
  "type": "object",
  "required": [
    "date",
    "marketplace",
    "account_id",
    "currency",
    "run_id"
  ],
  "properties": {
    "metadata": {
      "type": "object",
      "description": "Metadata fields required for all records",
      "required": [
        "date",
        "marketplace",
        "account_id",
        "currency",
        "run_id"
      ],
      "properties": {
        "date": {
          "type": "string",
          "format": "date",
          "description": "Report date in CST/CDT (YYYY-MM-DD)"
        },
        "marketplace": {
          "type": "string",
          "description": "Marketplace identifier (e.g., US, CA, MX, WM_US)",
          "enum": ["US", "CA", "MX", "UK", "DE", "FR", "IT", "ES", "JP", "AU", "WM_US"]
        },
        "account_id": {
          "type": "string",
          "description": "Seller or ad account identifier"
        },
        "currency": {
          "type": "string",
          "description": "ISO 4217 currency code",
          "pattern": "^[A-Z]{3}$"
        },
        "attribution_window": {
          "type": "integer",
          "description": "Attribution window in days (for ads metrics)",
          "minimum": 1,
          "maximum": 30
        },
        "data_source_version": {
          "type": "string",
          "description": "API version used to fetch data"
        },
        "report_id": {
          "type": "string",
          "description": "Source report identifier from API"
        },
        "run_id": {
          "type": "string",
          "description": "Workflow run identifier (unique per execution)"
        },
        "last_updated": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of last update"
        }
      }
    },
    "sales_metrics": {
      "type": "object",
      "description": "Sales-related metrics",
      "properties": {
        "total_orders": {
          "type": "number",
          "description": "Total number of orders",
          "minimum": 0
        },
        "total_revenue": {
          "type": "number",
          "description": "Gross revenue before refunds",
          "minimum": 0
        },
        "net_revenue": {
          "type": "number",
          "description": "Revenue after refunds",
          "minimum": 0
        },
        "units_sold": {
          "type": "number",
          "description": "Total units sold",
          "minimum": 0
        },
        "avg_order_value": {
          "type": "number",
          "description": "Average order value (total_revenue / total_orders)",
          "minimum": 0
        },
        "refunds_amount": {
          "type": "number",
          "description": "Total refund amount",
          "minimum": 0
        },
        "refund_rate": {
          "type": "number",
          "description": "Percentage of orders refunded",
          "minimum": 0,
          "maximum": 100
        },
        "order_status_shipped": {
          "type": "number",
          "description": "Orders with shipped status",
          "minimum": 0
        },
        "order_status_pending": {
          "type": "number",
          "description": "Orders with pending status",
          "minimum": 0
        },
        "order_status_cancelled": {
          "type": "number",
          "description": "Orders with cancelled status",
          "minimum": 0
        },
        "organic_sales": {
          "type": "number",
          "description": "Sales not attributed to ads",
          "minimum": 0
        },
        "promoted_sales": {
          "type": "number",
          "description": "Sales attributed to ads",
          "minimum": 0
        },
        "fulfillment_by_amazon": {
          "type": "number",
          "description": "FBA orders count",
          "minimum": 0
        },
        "fulfillment_by_merchant": {
          "type": "number",
          "description": "FBM orders count",
          "minimum": 0
        },
        "product_sales_top_skus": {
          "type": "array",
          "description": "Top SKUs by sales (optional)",
          "items": {
            "type": "object",
            "properties": {
              "sku": {
                "type": "string"
              },
              "units": {
                "type": "number"
              },
              "revenue": {
                "type": "number"
              }
            }
          }
        }
      }
    },
    "ads_metrics": {
      "type": "object",
      "description": "Advertising-related metrics",
      "properties": {
        "ad_spend": {
          "type": "number",
          "description": "Total advertising spend",
          "minimum": 0
        },
        "ad_sales": {
          "type": "number",
          "description": "Sales attributed to ads",
          "minimum": 0
        },
        "ad_orders": {
          "type": "number",
          "description": "Orders from ads",
          "minimum": 0
        },
        "impressions": {
          "type": "number",
          "description": "Ad impressions",
          "minimum": 0
        },
        "clicks": {
          "type": "number",
          "description": "Ad clicks",
          "minimum": 0
        },
        "ctr": {
          "type": "number",
          "description": "Click-through rate (clicks / impressions * 100)",
          "minimum": 0,
          "maximum": 100
        },
        "cpc": {
          "type": "number",
          "description": "Cost per click (ad_spend / clicks)",
          "minimum": 0
        },
        "acos": {
          "type": "number",
          "description": "Advertising Cost of Sales (ad_spend / ad_sales * 100)",
          "minimum": 0
        },
        "tacos": {
          "type": "number",
          "description": "Total Advertising Cost of Sales (ad_spend / total_revenue * 100)",
          "minimum": 0
        },
        "roas": {
          "type": "number",
          "description": "Return on ad spend (ad_sales / ad_spend)",
          "minimum": 0
        },
        "conversion_rate": {
          "type": "number",
          "description": "Orders per click (ad_orders / clicks * 100)",
          "minimum": 0,
          "maximum": 100
        },
        "campaign_type_sp": {
          "type": "number",
          "description": "Sponsored Products spend",
          "minimum": 0
        },
        "campaign_type_sb": {
          "type": "number",
          "description": "Sponsored Brands spend",
          "minimum": 0
        },
        "campaign_type_sd": {
          "type": "number",
          "description": "Sponsored Display spend",
          "minimum": 0
        },
        "ad_attribution_window": {
          "type": "integer",
          "description": "Attribution window used for ads metrics",
          "minimum": 1,
          "maximum": 30
        }
      }
    },
    "computed_metrics": {
      "type": "object",
      "description": "Derived metrics computed from raw fields",
      "properties": {
        "acos": {
          "type": "number",
          "description": "Computed: ad_spend / ad_sales * 100"
        },
        "tacos": {
          "type": "number",
          "description": "Computed: ad_spend / total_revenue * 100"
        },
        "ctr": {
          "type": "number",
          "description": "Computed: clicks / impressions * 100"
        },
        "cpc": {
          "type": "number",
          "description": "Computed: ad_spend / clicks"
        },
        "roas": {
          "type": "number",
          "description": "Computed: ad_sales / ad_spend"
        },
        "conversion_rate": {
          "type": "number",
          "description": "Computed: ad_orders / clicks * 100"
        },
        "avg_order_value": {
          "type": "number",
          "description": "Computed: total_revenue / total_orders"
        },
        "refund_rate": {
          "type": "number",
          "description": "Computed: (refunds_amount / total_revenue) * 100"
        }
      }
    }
  }
}
